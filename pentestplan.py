import os
from mitreattack.stix20 import MitreAttackData
import requests

# Load the MITRE ATT&CK dataset using MitreAttackData
mitre_attack_data = MitreAttackData("enterprise-attack.json")

API_URL = "" # Ensure this is the correct URL


def extract_keywords_from_description(description):
    # Define the merged prompt
    prompt = (f"Given the cybersecurity scenario description: '{description}', identify and list the key terms, "
              "techniques, or technologies relevant to MITRE ATT&CK. Extract TTPs from the scenario. "
              "If the description is too basic, expand upon it with additional details, applicable campaign, "
              "or attack types based on dataset knowledge. Then, extract the TTPs from the revised description.")
    
    messages = {"prompt": f"You are a cybersecurity professional with more than 25 years of experience.\n{prompt}"}

    # Make the API call
    try:
        response_content = send_prompt(messages)
        return response_content.split(', ')

    except Exception as e:
        print("An error occurred while connecting to the server:", e)
        return []



def send_prompt(prompt):
    """Execute the API call."""
    try:
        # Send the POST request
        response = requests.post(
            API_URL, 
            json=prompt, 
            headers={"Content-Type": "application/json"},
            timeout=300  # Increased timeout to 5 minutes (300 seconds)
            )
            
        # Check for HTTP errors (4xx or 5xx)
        response.raise_for_status()
            
        # Process successful response
        response_json = response.json()
            
        # Extract the generated text from the JSON response structure
        if 'response' in response_json:
            return response_json['response']

    except requests.exceptions.RequestException as e:
        # Handle network errors (connection, timeout, DNS, etc.)
        error_message = f"Network Error: Could not connect to FastAPI server at {API_URL}. \n\nPlease ensure the server is running."
        print(error_message)
    except json.JSONDecodeError:
        print(f"JSON Decode Error: Failed to parse response from server: {response.text}")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")




def generate_ttp_chain(match):
    # Create a prompt for GPT-3 to generate a TTP chain for the provided match
    prompt = (f"Given the MITRE ATT&CK technique '{match['name']}' and its description '{match['description']}', "
              "generate an example scenario and TTP chain demonstrating its use.")
    
    messages = {"prompt": f"You are a cybersecurity professional with expertise in MITRE ATT&CK techniques.\n{prompt}"}
    # Make the API call
    try:
        response_content = send_prompt(messages)
        return response_content

    except Exception as e:
        print("An error occurred while generating the TTP chain:", e)
        return "Unable to generate TTP chain."



if __name__ == '__main__':
    print(f"Client is configured to connect to: {API_URL}")
    print("PLEASE ENSURE YOUR FASTAPI SERVER (gpt4all_api.py) IS RUNNING FIRST.")
    print("----------------------------------------------------------------------")
    description = input("Enter your scenario description: ")
    keywords = extract_keywords_from_description(description)
    print(keywords)
    #matches = search_dataset_for_matches(keywords)
    #scored_matches = score_matches(matches, keywords)

    # Sort by score in descending order and take the top 3
    #top_matches = sorted(scored_matches, key=lambda x: x[1], reverse=True)[:3]

    """print("Top 3 matches from the MITRE ATT&CK dataset:")
    for match, score in top_matches:
        print("Name:", match['name'])
        print("Summary:", match['description'])
        ttp_chain = generate_ttp_chain(match)
        print("Example Scenario and TTP Chain:", ttp_chain)
        print("-" * 50)"""




